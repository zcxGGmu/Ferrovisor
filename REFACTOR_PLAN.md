# Ferrovisor - Xvisor Rust 重构计划

## 项目概述

Ferrovisor 是将 C 语言实现的 Xvisor Type-1 Hypervisor 用 Rust 重构的项目，保持原有功能的同时利用 Rust 的内存安全、并发性和零成本抽象特性。项目名称 "Ferrovisor" 结合了 "Ferrum"（拉丁语：铁，象征 Rust）和 "Hypervisor"。

## 重构原则

1. **安全性优先**：利用 Rust 的所有权系统确保内存安全
2. **性能保持**：保持与原版相当的性能水平
3. **架构清晰**：使用 Rust 的模块系统提供清晰的架构
4. **渐进式重构**：分阶段实施，每个阶段都有可运行的版本
5. **测试驱动**：为核心组件编写单元测试和集成测试

## 技术栈选择

- **核心语言**：Rust (no_std 环境)
- **异步运行时**：自实现轻量级运行时
- **内存管理**：自定义分配器
- **并发原语**：自旋锁、互斥锁等
- **构建系统**：Cargo + 自定义构建脚本
- **配置系统**：基于 TOML/YAML 的配置

## 分阶段实施计划

### 第一阶段：基础框架搭建（第1周）

#### 1.1 项目初始化
- [x] 创建 Rust 项目结构
- [ ] 设置 no_std 环境
- [ ] 配置自定义目标（armv8a、riscv64、x86_64）
- [ ] 建立构建系统

#### 1.2 核心抽象定义
- [ ] 定义错误处理机制
- [ ] 实现基础数据结构
- [ ] 定义日志系统
- [ ] 实现基础工具函数

#### 1.3 硬件抽象层
- [ ] 定义 CPU 寄存器抽象
- [ ] 实现内存管理单元（MMU）抽象
- [ ] 实现中断控制器抽象
- [ ] 定义计时器抽象

### 第二阶段：内存管理实现（第2-3周）

#### 2.1 物理内存管理
- [ ] 实现页帧分配器
- [ ] 实现物理内存映射
- [ ] 实现内存区域管理

#### 2.2 虚拟内存管理
- [ ] 实现页表管理
- [ ] 实现地址空间抽象
- [ ] 实现内存映射/取消映射
- [ ] 实现 TLB 管理

#### 2.3 堆内存管理
- [ ] 实现内核堆分配器
- [ ] 实现 Slab 分配器
- [ ] 实现内存池管理

### 第三阶段：虚拟机核心（第4-5周）

#### 3.1 VCPU 实现
- [ ] 定义 VCPU 结构体
- [ ] 实现上下文切换
- [ ] 实现虚拟 CPU 状态管理
- [ ] 实现 VCPU 调度接口

#### 3.2 虚拟机管理
- [ ] 实现虚拟机生命周期管理
- [ ] 实现虚拟机配置管理
- [ ] 实现虚拟机资源分配
- [ ] 实现虚拟机隔离

#### 3.3 调度器实现
- [ ] 实现调度器抽象
- [ ] 实现优先级调度算法
- [ ] 实现时间片轮转
- [ ] 实现负载均衡

### 第四阶段：中断和异常处理（第6周）

#### 4.1 中断框架
- [ ] 实现中断向量表
- [ ] 实现中断处理框架
- [ ] 实现中断优先级管理
- [ ] 实现中断路由

#### 4.2 异常处理
- [ ] 实现异常分类和处理
- [ ] 实现陷阱处理
- [ ] 实现系统调用处理
- [ ] 实现虚拟化异常处理

### 第五阶段：设备虚拟化（第7-8周）

#### 5.1 设备模拟框架
- [ ] 实现设备抽象
- [ ] 实现设备总线模拟
- [ ] 实现设备内存映射
- [ ] 实现设备中断注入

#### 5.2 基础设备模拟
- [ ] 实现 UART 串口
- [ ] 实现 RTC 实时时钟
- [ ] 实现 GPIO 控制器
- [ ] 实现 PIC 中断控制器

#### 5.3 VirtIO 实现
- [ ] 实现 VirtIO 框架
- [ ] 实现 VirtIO 网络
- [ ] 实现 VirtIO 块设备
- [ ] 实现 VirtIO 控制台

### 第六阶段：特定架构支持（第9-10周）

#### 6.1 ARM64 支持
- [ ] 实现 ARMv8a 虚拟化扩展
- [ ] 实现 VHE（虚拟化主机扩展）
- [ ] 实现 GICv2/GICv3 中断控制器
- [ ] 实现 ARM 特有的设备模拟

#### 6.2 RISC-V 支持
- [ ] 实现 RISC-V H 扩展
- [ ] 实现 AIA 中断架构
- [ ] 实现 RISC-V 特有特性
- [ ] 支持 SBI 接口

#### 6.3 x86_64 支持
- [ ] 实现 Intel VT-x/AMD-V
- [ ] 实现 APIC/IOAPIC
- [ ] 实现 MSR 管理
- [ ] 实现 x86 特有功能

### 第七阶段：高级功能（第11-12周）

#### 7.1 动态管理
- [ ] 实现运行时模块加载
- [ ] 实现热插拔支持
- [ ] 实现动态内存调整
- [ ] 实现 VCPU 热添加/移除

#### 7.2 性能优化
- [ ] 实现 virtio 后端优化
- [ ] 实现 I/O 批处理
- [ ] 实现内存预取
- [ ] 实现缓存优化

#### 7.3 管理接口
- [ ] 实现命令行接口
- [ ] 实现监控接口
- [ ] 实现调试支持
- [ ] 实现性能分析

### 第八阶段：测试和文档（第13周）

#### 8.1 测试套件
- [ ] 编写单元测试
- [ ] 编写集成测试
- [ ] 实现模拟测试
- [ ] 实现性能测试

#### 8.2 文档完善
- [ ] 编写架构文档
- [ ] 编写 API 文档
- [ ] 编写移植指南
- [ ] 编写用户手册

## 项目结构

```
Ferrovisor/
├── Cargo.toml                 # 主项目配置
├── build.rs                   # 构建脚本
├── README.md                  # 项目说明
├── REFACTOR_PLAN.md           # 本文档
├── .gitignore                 # Git 忽略文件
├── rust-toolchain.toml        # Rust 工具链配置
├── src/
│   ├── lib.rs                 # 库入口
│   ├── main.rs                # 主程序入口
│   ├── arch/                  # 架构相关代码
│   │   ├── mod.rs
│   │   ├── arm64/
│   │   │   ├── mod.rs
│   │   │   ├── boot.rs
│   │   │   ├── mmu.rs
│   │   │   ├── gic.rs
│   │   │   └── timer.rs
│   │   ├── riscv64/
│   │   │   ├── mod.rs
│   │   │   ├── boot.rs
│   │   │   ├── csrs.rs
│   │   │   ├── pmp.rs
│   │   │   └── clic.rs
│   │   ├── x86_64/
│   │   │   ├── mod.rs
│   │   │   ├── boot.rs
│   │   │   ├── vmx.rs
│   │   │   └── apic.rs
│   │   └── common/
│   │       ├── mod.rs
│   │       ├── cpu.rs
│   │       └── io.rs
│   ├── core/                  # 核心模块
│   │   ├── mod.rs
│   │   ├── vmm/               # 虚拟机管理器
│   │   │   ├── mod.rs
│   │   │   ├── vm.rs
│   │   │   ├── vcpu.rs
│   │   │   └── vmcs.rs
│   │   ├── sched/             # 调度器
│   │   │   ├── mod.rs
│   │   │   ├── scheduler.rs
│   │   │   ├── rr.rs
│   │   │   └── fifo.rs
│   │   ├── mm/                # 内存管理
│   │   │   ├── mod.rs
│   │   │   ├── frame.rs
│   │   │   ├── page.rs
│   │   │   ├── heap.rs
│   │   │   └── slab.rs
│   │   ├── irq/               # 中断处理
│   │   │   ├── mod.rs
│   │   │   ├── manager.rs
│   │   │   ├── chip.rs
│   │   │   └── domain.rs
│   │   └── sync/              # 同步原语
│   │       ├── mod.rs
│   │       ├── mutex.rs
│   │       ├── spinlock.rs
│   │       └── semaphore.rs
│   ├── drivers/               # 设备驱动
│   │   ├── mod.rs
│   │   ├── base/
│   │   │   ├── mod.rs
│   │   │   ├── device.rs
│   │   │   └── driver.rs
│   │   ├── virtio/
│   │   │   ├── mod.rs
│   │   │   ├── transport.rs
│   │   │   ├── blk.rs
│   │   │   └── net.rs
│   │   └── platform/
│   │       ├── mod.rs
│   │       ├── uart.rs
│   │       └── rtc.rs
│   ├── emulator/              # 设备模拟
│   │   ├── mod.rs
│   │   ├── uart/
│   │   │   ├── mod.rs
│   │   │   └── pl011.rs
│   │   ├── rtc/
│   │   │   └── pl031.rs
│   │   └── gpio/
│   │       └── pl061.rs
│   ├── utils/                 # 工具函数
│   │   ├── mod.rs
│   │   ├── log.rs
│   │   ├── console.rs
│   │   ├── bitmap.rs
│   │   └── list.rs
│   └── config/                # 配置管理
│       ├── mod.rs
│       └── vm_config.rs
├── tests/                     # 测试代码
│   ├── integration/
│   └── unit/
├── examples/                  # 示例代码
│   ├── minimal_vm/
│   └── hello_world/
├── docs/                      # 文档
│   ├── architecture/
│   ├── api/
│   └── tutorials/
└── config/                    # 配置文件
    ├── arm64_defconfig.toml
    ├── riscv64_defconfig.toml
    └── x86_64_defconfig.toml
```

## 开发规范

### 代码风格
- 遵循 Rust 官方代码风格
- 使用 rustfmt 格式化代码
- 使用 clippy 进行代码检查

### 提交规范
- 每个功能模块一个提交
- 提交信息使用英文，格式：
  ```
  <type>(<scope>): <description>

  [optional body]

  [optional footer]
  ```

  类型包括：
  - feat: 新功能
  - fix: 修复
  - docs: 文档
  - style: 格式
  - refactor: 重构
  - test: 测试
  - chore: 构建/工具

### 分支管理
- main: 稳定分支
- develop: 开发分支
- feature/*: 功能分支
- release/*: 发布分支

## 里程碑

- **v0.1.0 (第一周结束)**：基础框架，可以启动进入 shell
- **v0.2.0 (第三周结束)**：内存管理和虚拟机基本功能
- **v0.3.0 (第六周结束)**：中断处理和基础设备模拟
- **v0.4.0 (第八周结束)**：VirtIO 支持和完整 ARM64 支持
- **v0.5.0 (第十周结束)**：RISC-V 和 x86_64 支持
- **v0.6.0 (第十三周结束)**：生产就绪版本

## 风险评估

1. **复杂性风险**：Xvisor 功能复杂，重构可能遗漏某些细节
2. **性能风险**：Rust 的抽象可能带来性能开销
3. **兼容性风险**：需要确保与现有客户机的兼容性
4. **时间风险**：重构周期长，需要持续投入

## 应对策略

1. **分阶段实施**：每个阶段产出可运行版本
2. **性能基准测试**：持续对比原版性能
3. **兼容性测试**：使用现有测试用例验证
4. **社区参与**：开源项目，吸引社区贡献

## 下一步行动

1. 初始化 Rust 项目结构
2. 设置构建系统
3. 实现基础框架
4. 开始第一个功能模块开发