# RISC-V 虚拟化扩展（H扩展）概述

## 简介

RISC-V 虚拟化扩展（H扩展）通过虚拟化监管级架构来支持在 type-1 或 type-2 虚拟机监控器上高效托管客户机操作系统。此扩展将监管模式转换为**监管器扩展监管模式（HS-mode）**，并为客户机物理地址添加了第二级地址转换。

## 核心概念

### 虚拟化模式 (V)
- **V=0**：非虚拟化模式（M模式、HS模式或U模式）
- **V=1**：虚拟化模式（VS模式或VU模式）

### H扩展下的特权模式

| 虚拟化模式 (V) | 标称特权 | 缩写 | 名称 | 两级地址转换 |
|----------------|----------|------|------|--------------|
| 0 | 0 | 0 | U | U模式 | 关闭 |
| 0 | 1 | 0 | S | HS模式 | 关闭 |
| 0 | 1 | 1 | M | M模式 | 关闭 |
| 1 | 0 | 0 | U | VU模式 | 开启 |
| 1 | 1 | 0 | S | VS模式 | 开启 |

## 核心特性

### 1. 两级地址转换
- **VS级**：客户机虚拟地址 (GVA) → 客户机物理地址 (GPA)
- **G级**：客户机物理地址 (GPA) → 监管物理地址 (SPA)
- 当 V=1 时两级都激活

### 2. 虚拟监管器 CSR
- **HS模式 CSR**：控制虚拟化和客户机管理
- **VS模式 CSR**：监管器 CSR 的副本，用于客户机执行
- 根据 V 模式在 HS 和 VS CSR 之间自动切换

### 3. 附加指令
- **虚拟内存访问**：HLV、HLVX、HSV（以 V=1 方式进行显式内存访问）
- **内存管理栅栏**：HFENCE.VVMA、HFENCE.GVMA

### 4. 中断管理
- **VS级中断**：虚拟软件中断、定时器中断和外部中断
- **客户机外部中断**：直接向客户机传递设备中断
- **中断委托**：两级委托（M→HS→VS）

## 实现要求

### 依赖项
- 基础整数 ISA RV32I 或 RV64I（非 RV32E/RV64E）
- 标准基于页面的地址转换（RV32 为 Sv32，RV64 为 Sv39+）
- `mtval` CSR 不能是只读零

### 扩展激活
- 在 `misa` CSR 中设置第 7 位以启用 H 扩展
- 字母 'H' 对应 H 扩展

## 性能优势

H 扩展相比经典虚拟化技术减少了 VM 退出的频率，带来：
- 减少虚拟机监控器开销
- 客户机操作系统执行接近原生性能
- 高效的硬件辅助虚拟化支持

## 兼容性

- 标准监管模式操作系统可以在 HS 模式或作为 VS 模式客户机无修改运行
- 可以在没有硬件支持的平台上高效模拟
- 支持嵌套虚拟化

## 下一步

详细技术规范请参见：
- [CSR 定义](csrs-zh.md)
- [地址转换](address-translation-zh.md)
- [指令](instructions-zh.md)
- [异常处理](exceptions-zh.md)