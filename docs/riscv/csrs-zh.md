# RISC-V 虚拟机监控器 CSR（控制和状态寄存器）

本文档描述了 RISC-V 虚拟化扩展引入或修改的所有控制和状态寄存器（CSR）。

## 虚拟机监控器级 CSR（HS模式）

### 状态和配置 CSR

#### hstatus - 虚拟机监控器状态寄存器
格式（HSXLEN 位读写）：
```
31..... 28 27 26 25 24 23.....20 19 18 17 16 15 14 13 12 11..10 9..8 7 6 5 4 3 2 1 0 (HSXLEN=64)
        |   |  |  |  |      |  |  |  |  |  |  |      |   |  | | | | | | |
        |   |  |  |  |      |  |  |  |  |  |  |      |   |  | | | | | | +- VSXL[1:0] (仅64位)
        |   |  |  |  |      |  |  |  |  |  |  |      |   |  | | | | | +--- HU (U模式下的虚拟机监控器)
        |   |  |  |  |      |  |  |  |  |  |  |      |   |  | | | | +----- SPV (监管器先前的虚拟化模式)
        |   |  |  |  |      |  |  |  |  |  |  |      |   |  | | | +------- SPVP (监管器先前的虚拟特权)
        |   |  |  |  |      |  |  |  |  |  |  |      |   |  | | +--------- GVA (客户机虚拟地址)
        |   |  |  |  |      |  |  |  |  |  |  |      |   |  | +----------- VSBE (虚拟监管器字节序)
        |   |  |  |  |      |  |  |  |  |  |  |      |   |  +--------------- VTSR (虚拟 SRET)
        |   |  |  |  |      |  |  |  |  |  |  |      |   +------------------ VTW (虚拟 WFI)
        |   |  |  |  |      |  |  |  |  |  |  |      +---------------------- VTVM (虚拟 TVM)
        |   |  |  |  |      |  |  |  |  |  |  +----------------------------- VGEIN[5:0] (虚拟客户机外部中断号)
```

关键字段：
- **VSXL**：控制 VS 模式的有效 XLEN（仅64位）
- **HU**：在 U 模式下启用虚拟机监控器指令
- **SPV**：陷阱进入时的先前虚拟化模式
- **SPVP**：陷阱进入时的先前虚拟特权级别
- **GVA**：陷阱是否写入了客户机虚拟地址
- **VSBE**：VS 模式内存访问的字节序
- **VTSR/VTW/VTVM**：VS 模式的 TSR/TW/TVM 虚拟版本
- **VGEIN**：选择客户机外部中断源

#### hedeleg - 虚拟机监控器异常委托寄存器
控制同步异常从 HS 模式委托到 VS 模式。

#### hideleg - 虚拟机监控器中断委托寄存器
控制中断从 HS 模式委托到 VS 模式。

### 中断 CSR

#### hvip - 虚拟机监控器虚拟中断挂起
指示发往 VS 模式的虚拟中断。

#### hip - 虚拟机监控器中断挂起
用 VS 级和虚拟机监控器特定中断补充 HS 级的 `sip`。

#### hie - 虚拟机监控器中断使能
包含 VS 级和虚拟机监控器特定中断的使能位。

### 客户机外部中断 CSR

#### hgeip - 虚拟机监控器客户机外部中断挂起
只读寄存器，指示挂起的客户机外部中断。

#### hgeie - 虚拟机监控器客户机外部中断使能
包含此 hart 客户机外部中断的使能位。

### 内存管理 CSR

#### hgatp - 虚拟机监控器客户机地址转换和保护
控制 G 级地址转换（客户机物理地址到监管物理地址）。

HSXLEN=64 的格式：
```
63.....59 58.....57 56.....44 43.....28 27.....0
|     |     |      |       |        |
|     |     |      |       |        +- PPN[43:0] (页表基址)
|     |     |      |       +---------- VMID[13:0] (虚拟机标识符)
|     |     |      +----------------- MODE[3:0] (转换方案)
|     |     +------------------------ 保留
|     +------------------------------ 保留
```

MODE 字段编码：
- 0：Bare（无转换）
- 8：Sv39x4（39位加2位扩展）
- 9：Sv48x4（48位加2位扩展）
- 10：Sv57x4（57位加2位扩展）

### 环境配置 CSR

#### henvcfg - 虚拟机监控器环境配置
控制 V=1 时的执行环境特性。

关键字段：
- **FIOM**：I/O 栅栏隐含内存栅栏
- **PBMTE**：G 级的 Svpbmt 扩展启用
- **ADUE**：VS 级自动 A/D 位更新
- **LPE**：VS 模式的 Zicfilp 扩展启用
- **SSE**：VS 模式的 Zicfiss 扩展启用

### 计数器 CSR

#### hcounteren - 虚拟机监控器计数器使能
控制硬件性能计数器对客户机 VM 的可用性。

#### htimedelta - 虚拟机监控器时间增量
实际 `time` CSR 与 VS/VU 模式返回值之间的 64 位增量。

### 陷阱相关 CSR

#### htval - 虚拟机监控器陷阱值
异常的附加信息（客户机页故障时的客户机物理地址）。

#### htinst - 虚拟机监控器陷阱指令
关于导致陷阱的指令的信息。

## 虚拟监管器 CSR（VS模式）

这些 CSR 仅在 V=1 时激活，替代普通的监管器 CSR：

| VS CSR | 普通监管器 CSR | 描述 |
|--------|----------------|------|
| vsstatus | sstatus | 虚拟监管器状态 |
| vsie | sie | 虚拟中断使能 |
| vsip | sip | 虚拟中断挂起 |
| vstvec | stvec | 虚拟陷阱向量基址 |
| vsscratch | sscratch | 虚拟暂存寄存器 |
| vsepc | sepc | 虚拟异常 PC |
| vscause | scause | 虚拟异常原因 |
| vstval | stval | 虚拟陷阱值 |
| vsatp | satp | 虚拟地址转换 |

## H扩展修改的机器级 CSR

### mstatus/mstatush
附加字段：
- **MPV**：机器先前的虚拟化模式
- **GVA**：客户机虚拟地址标志

### mideleg
位 10、6 和 2（VS 级中断）为只读 1。

### mip/mie
为 VS 级中断添加了活动位。

### mtval2 - 机器第二个陷阱值
M 模式陷阱的附加异常信息。

### mtinst - 机器陷阱指令
用于 M 模式的陷阱指令信息。

## CSR 访问规则

### 当 V=1 时：
- 监管器 CSR 访问对应的 VS CSR
- 直接访问 VS CSR 导致虚拟指令异常
- HS CSR 保留值但不影响执行

### 当 V=0 时：
- VS CSR 可读/写但不影响执行
- 普通监管器 CSR 正常工作

### 特权限制：
- 某些 CSR 只能从 M 模式/HS 模式访问
- 其他 CSR 可根据委托从所有模式访问