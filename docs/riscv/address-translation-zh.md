# RISC-V 两级地址转换

当启用虚拟化模式（V）时（V=1），RISC-V 虚拟化扩展实现了两级地址转换机制。这使得客户机操作系统可以使用虚拟内存，同时虚拟机监控器在客户机之间保持隔离。

## 概述

当 V=1 时，内存访问经历两级转换：

1. **VS 级（第一级）**：客户机虚拟地址 (GVA) → 客户机物理地址 (GPA)
   - 由 `vsatp` CSR 控制
   - 使用标准的基于页面的转换（Sv32、Sv39、Sv48、Sv57）

2. **G 级（第二级）**：客户机物理地址 (GPA) → 监管物理地址 (SPA)
   - 由 `hgatp` CSR 控制
   - 使用扩展的页格式（Sv32x4、Sv39x4、Sv48x4、Sv57x4）

## VS 级转换（虚拟监管器）

由 `vsatp` 寄存器控制，使用标准的 RISC-V 虚拟内存方案：

### 支持的方案
- **Sv32**：32 位虚拟地址，34 位物理地址
- **Sv39**：39 位虚拟地址，56 位物理地址
- **Sv48**：48 位虚拟地址，56 位物理地址
- **Sv57**：57 位虚拟地址，56 位物理地址

### VS 级页表项
标准 RISC-V 页表项格式：
```
63.....10 9.....8 7.....6 5.....4 3.....2 1.....0
|       |   |   |   |   |   |   |   |   |
|       +---+---+---+---+---+---+---+---+--- PPN
|           |   |   |   |   |   |   +----- X (可执行)
|           |   |   |   |   |   +--------- W (可写)
|           |   |   |   |   +------------- R (可读)
|           |   |   |   +------------------- U (用户)
|           |   |   +----------------------- G (全局)
|           |   +--------------------------- A (已访问)
|           +------------------------------- D (脏)
+------------------------------------------- V (有效)
```

## G 级转换（客户机物理）

由 `hgatp` 寄存器控制，使用扩展的页格式：

### 支持的方案
- **Bare**：无转换（GPA = SPA）
- **Sv32x4**：34 位客户机物理地址
- **Sv39x4**：41 位客户机物理地址
- **Sv48x4**：50 位客户机物理地址
- **Sv57x4**：59 位客户机物理地址

### 扩展地址格式

#### Sv32x4（34 位 GPA）
```
33.....22 21.....12 11.....2 1.....0
|         |         |        |
| VPN[1]  | VPN[0]  | 偏移 |
```

#### Sv39x4（41 位 GPA）
```
40.....30 29.....21 20.....12 11.....2 1.....0
|         |         |         |        |
| VPN[2]  | VPN[1]  | VPN[0]  | 偏移 |
```

#### Sv48x4（50 位 GPA）
```
49.....39 38.....30 29.....21 20.....12 11.....2 1.....0
|         |         |         |         |        |
| VPN[3]  | VPN[2]  | VPN[1]  | VPN[0]  | 偏移 |
```

#### Sv57x4（59 位 GPA）
```
58.....48 47.....39 38.....30 29.....21 20.....12 11.....2 1.....0
|         |         |         |         |         |        |
| VPN[4]  | VPN[3]  | VPN[2]  | VPN[1]  | VPN[0]  | 偏移 |
```

### 与标准转换的主要区别

1. **根页表大小**：16 KiB 而非 4 KiB（大 4 倍）
2. **对齐**：根页表必须 16 KiB 对齐
3. **地址扩展**：物理地址宽度增加 2 位
4. **VMID**：虚拟机标识符用于隔离

### G 级 PTE 格式
使用与标准 RISC-V 页表项相同的格式，有一个例外：
- **G 位**：为未来标准使用保留（软件应清除）

## 转换过程

### 逐步转换流程

1. **确定有效模式**
   - 检查当前虚拟化模式（V）
   - 检查有效特权级别
   - 验证 `hgatp` 和 `vsatp` 是否激活

2. **VS 级转换**（如果激活）
   - 使用 `vsatp.MODE` 选择转换方案
   - 遍历客户机页表
   - 应用 VS 级权限
   - 处理 A/D 位更新（如果启用）
   - 结果：客户机物理地址（GPA）

3. **G 级转换**（如果 V=1）
   - 使用 `hgatp.MODE` 选择转换方案
   - 遍历虚拟机监控器页表（16 KiB 根）
   - 应用 G 级权限
   - 检查 VMID 匹配
   - 结果：监管物理地址（SPA）

4. **物理内存保护**
   - 对最终 SPA 应用 PMP 检查
   - 强制内存属性

### 特殊情况

#### 绕过转换的内存访问
- 物理内存访问绕过 VS 级
- 当 V=1 时仍经历 G 级转换
- 包括 VS 级页表遍历

#### 指令获取
- 权限可能与加载/存储不同
- 通过 MXR 位处理仅可执行页面

## 虚拟机标识符（VMID）

### hgatp 中的 VMID 字段
- **VMIDLEN**：实现特定的宽度（0-14 位）
- **VMIDMAX**：支持的最大 VMID 宽度
  - Sv32x4 为 7
  - Sv39x4、Sv48x4、Sv57x4 为 14

### VMID 使用
- 标识不同的虚拟机
- 用于地址转换缓存隔离
- HFENCE.GVMA 同步需要 VMID

## 内存管理栅栏

### SFENCE.VMA
- V=0 时：操作 HS 级转换
- V=1 时：操作当前 VMID 内的 VS 级转换

### HFENCE.VVMA（虚拟机监控器）
- 使 VS 级转换失效
- 可选择指定 VA 和 ASID
- 只影响当前 VMID

### HFENCE.GVMA（虚拟机监控器）
- 使 G 级转换失效
- 可选择指定 GPA 和 VMID
- 更改 `hgatp` MODE 时至关重要

## 权限检查

### 访问权限
- **读（R）**：加载权限
- **写（W）**：存储权限
- **执行（X）**：指令获取权限
- **用户（U）**：用户模式访问

### MXR（使可执行页面可读）
- **vsstatus.MXR**：仅影响 VS 级
- **sstatus.MXR**：影响两级
- 允许读取仅可执行页面

### 页表更新规则
- A/D 位仅在实际内存访问时设置
- 不在推测执行时设置
- 由 Svadu 扩展启用控制

## 性能考虑

### 转换缓存
- TLB 条目可以缓存两级
- VMID 用于缓存隔离
- 支持选择性失效

### 地址计算开销
- 两级转换增加延迟
- 硬件加速至关重要
- 根页表大小影响缓存使用

## 与其他扩展的交互

### Svpbmt 扩展
- 由 `henvcfg.PBMTE` 控制 G 级
- PTE 中的内存类型属性

### Svadu 扩展
- 由 `henvcfg.ADUE` 控制 VS 级
- 自动 A/D 位管理

### Zicfilp 扩展
- 由 `henvcfg.LPE` 控制 VS 模式
- 着陆点预测

### Zicfiss 扩展
- 由 `henvcfg.SSE` 控制 VS 模式
- 影子栈支持