# RISC-V 虚拟机监控器指令

RISC-V 虚拟化扩展引入了几条新指令并修改了现有指令的行为，以支持高效的虚拟化。

## 虚拟机访问指令

这些指令允许像在虚拟化模式（V=1）中执行一样进行显式内存访问。它们只在 M 模式、HS 模式或当 `hstatus.HU=1` 时的 U 模式中有效。

### 加载指令

| 指令 | 描述 | 数据宽度 | 访问类型 |
|-------|------|----------|----------|
| HLV.B | 虚拟机加载字节 | 8 位 | 有符号 |
| HLV.BU | 虚拟机加载字节无符号 | 8 位 | 无符号 |
| HLV.H | 虚拟机加载半字 | 16 位 | 有符号 |
| HLV.HU | 虚拟机加载半字无符号 | 16 位 | 无符号 |
| HLV.W | 虚拟机加载字 | 32 位 | 有符号 |
| HLV.WU | 虚拟机加载字无符号 | 32 位 | 无符号 |
| HLV.D | 虚拟机加载双字 | 64 位 | 有符号 |

### 存储指令

| 指令 | 描述 | 数据宽度 |
|-------|------|----------|
| HSV.B | 虚拟机存储字节 | 8 位 |
| HSV.H | 虚拟机存储半字 | 16 位 |
| HSV.W | 虚拟机存储字 | 32 位 |
| HSV.D | 虚拟机存储双字 | 64 位 |

### 仅执行访问指令

这些指令需要执行权限但不需要读权限：

| 指令 | 描述 | 注意 |
|------|------|------|
| HLVX.HU | 虚拟机加载半字无符号仅执行 | 不能覆盖 PMP 仅执行 |
| HLVX.WU | 虚拟机加载字无符号仅执行 | 即使 RV32 也有效 |

### 指令行为

1. **地址转换**：始终使用两级地址转换（V=1）
2. **特权级别**：由 `hstatus.SPVP` 控制
   - SPVP=0：作为 VU 模式访问
   - SPVP=1：作为 VS 模式访问
3. **内存属性**：使用 `hstatus.VSBE` 确定字节序
4. **MXR 处理**：HS 级 MXR 影响两级，VS 级 MXR 仅影响 VS 级

## 内存管理栅栏指令

这些特权栅栏指令管理转换缓存失效。

### HFENCE.VVMA - VS 虚拟内存的虚拟机监控器栅栏

```assembly
HFENCE.VVMA rs1, rs2
```

**目的**：在随后的 VS 级转换之前对 VS 级页表的存储进行排序。

**操作数**：
- `rs1`：客户机虚拟地址寄存器（x0 = 所有地址）
- `rs2`：客户机 ASID 寄存器（x0 = 所有 ASID）

**有效模式**：仅 M 模式或 HS 模式

**效果**：
- 使匹配以下条件的 VS 级 TLB 条目失效：
  - 指定的客户机虚拟地址（如果 rs1 ≠ x0）
  - 指定的 ASID（如果 rs2 ≠ x0）
  - 来自 `hgatp.VMID` 的当前 VMID

### HFENCE.GVMA - 客户机物理内存的虚拟机监控器栅栏

```assembly
HFENCE.GVMA rs1, rs2
```

**目的**：在随后的 G 级转换之前对 G 级页表的存储进行排序。

**操作数**：
- `rs1`：客户机物理地址寄存器，右移 2 位（x0 = 所有地址）
- `rs2`：VMID 寄存器（x0 = 所有 VMID）

**有效模式**：HS 模式（当 `mstatus.TVM=0`时）或 M 模式

**效果**：
- 使匹配以下条件的 G 级 TLB 条目失效：
  - 指定的客户机物理地址（如果 rs1 ≠ x0）
  - 指定的 VMID（如果 rs2 ≠ x0）

### 重要说明

1. **无 TVM/VTVM 限制**：当 `mstatus.TVM=1` 或 `hstatus.VTVM=1` 时，这些栅栏不会陷入
2. **VMID 处理**：更改 `hgatp` 可能需要 HFENCE.GVMA
3. **地址编码**：HFENCE.GVMA 中的客户机物理地址右移 2 位

## 修改的现有指令

### SRET - 监管器返回

根据当前虚拟化模式修改行为：

#### V=0 时（HS 模式或 M 模式）
- 使用 `hstatus.SPV` 和 `sstatus.SPP`
- 根据 SPP 设置新模式
- 根据 SPV 设置 V

#### V=1 时（VS 模式）
- 只使用 `vsstatus.SPP`
- 根据 SPP 设置特权
- V 保持为 1

### SFENCE.VMA - 监管器栅栏

根据虚拟化模式修改行为：

#### V=0 时
- 操作 HS 级地址转换
- 使用 HS 级虚拟地址和 ASID

#### V=1 时
- 操作 VS 级地址转换
- 使用客户机虚拟地址和 ASID
- 受当前 VMID 影响

### WFI - 等待中断

修改的陷入条件：
- 在 VS 模式下当 `hstatus.VTW=1`：作为虚拟指令陷入
- 在 VU 模式下当 `mstatus.TW=0`：作为虚拟指令陷入
- 其他情况正常 WFI 行为

### CSR 访问指令

#### V=1 时的访问规则
- 监管器 CSR 访问对应的 VS CSR
- 直接访问 VS CSR 导致虚拟指令异常
- 某些监管器 CSR 没有 VS 副本（保持正常）

#### 高位 CSR 处理（XLEN=32）
- 无效的高位访问可能导致虚拟指令异常
- 由对应的低位 CSR 可访问性决定

## 异常条件

### 虚拟指令异常

当满足以下条件时，虚拟指令异常代替非法指令异常：

1. **HS 限定指令**在 V=1 时被阻止：
   - 当 `hcounteren` 位清除时访问计数器
   - 访问虚拟机监控器 CSR
   - 直接访问 VS CSR
   - 在 VS 模式下当 VTW=1 时执行 WFI
   - 在 VS 模式下当 VTSR=1 时执行 SRET
   - 在 VS 模式下当 VTVM=1 时执行 SFENCE.VMA/SINVAL.VMA

2. **在 VS/VU 模式下执行时 V=1**：
   - 虚拟机指令（HLV、HLVX、HSV、HFENCE）
   - 监管器指令（SRET、SFENCE）
   - 某些监管器 CSR 访问

### 非法指令异常

对于：
1. 非 HS 限定的指令
2. FS/VS = 0 时的浮点/向量指令
3. 访问未实现的 CSR
4. 未被虚拟指令规则覆盖的特权违规

## 指令编码细节

### 虚拟内存访问指令

所有 HLV/HLVX/HSV 指令遵循此编码模式：

```
31.....26 25.....20 19.....15 14.....12 11.....7 6.....0
| opcode | funct3 | rs1 | funct2 | rs1' | rd | opcode
```

### 内存栅栏指令

HFENCE 指令使用系统指令操作码空间，具有自定义的 funct3/funct7 值。

## 性能考虑

### 执行模式
- **原生**：无 V=1，标准监管器执行
- **模拟**：V=1，具有两级地址转换的客户机执行
- **虚拟机监控器访问**：用于 VM 状态的 HLV/HSV 指令

### 缓存一致性
- HFENCE 指令对 TLB 一致性至关重要
- VMID 更改需要 G 级栅栏
- 地址空间更改需要 VS 级栅栏

### 最佳实践
1. 更新 VS 页表后使用 HFENCE.VVMA
2. 更新 G 级页表后使用 HFENCE.GVMA
3. 为简单起见考虑使用广域栅栏（rs1=x0, rs2=x0）
4. 在多 VM 场景中考虑 VMID