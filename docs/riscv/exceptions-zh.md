# RISC-V 虚拟机监控器陷阱和异常处理

本文档描述了 RISC-V 虚拟化扩展提供的陷阱处理、异常委托和增强的异常机制。

## 陷阱原因码

H 扩展为虚拟化特定事件添加了新的陷阱原因码。

### 新增异常码

| 代码 | 名称 | 描述 |
|------|------|-------------|
| 20 | 指令客户机页故障 | 指令获取时的客户机页故障 |
| 21 | 加载客户机页故障 | 加载时的客户机页故障 |
| 22 | 虚拟指令 | 虚拟化模式下的非法指令 |
| 23 | 存储/AMO 客户机页故障 | 存储/AMO 时的客户机页故障 |

### 新增中断码

| 代码 | 名称 | 描述 |
|------|------|-------------|
| 2 | 虚拟监管器软件中断 | VS 级软件中断 |
| 6 | 虚拟监管器定时器中断 | VS 级定时器中断 |
| 10 | 虚拟监管器外部中断 | VS 级外部中断 |
| 12 | 监管器客户机外部中断 | HS 级客户机外部中断 |

## 异常委托

### 两级委托流程

```
M 模式
  ├── medeleg/mideleg
  ├── HS 模式
  │   ├── hedeleg/hideleg
  │   └── VS 模式（客户机）
  └── 直接 M 模式处理
```

### 委托规则

1. **M → HS**：由 `medeleg`/`mideleg` 控制
2. **HS → VS**：由 `hedeleg`/`hideleg` 控制
3. **必须委托**：VS 级中断总是委托超过 M 模式

### hedeleg - 虚拟机监控器异常委托

| 位 | 异常 | 必须可写 | 只读条件 |
|-----|-----------|----------------|-----------|
| 0 | 指令地址不对齐 | 是（如果 IALIGN=32） | - |
| 1 | 指令访问故障 | 是 | - |
| 2 | 非法指令 | 是 | - |
| 3 | 断点 | 是 | - |
| 4 | 加载地址不对齐 | 是 | - |
| 5 | 加载访问故障 | 是 | - |
| 6 | 存储/AMO 地址不对齐 | 是 | - |
| 7 | 存储/AMO 访问故障 | 是 | - |
| 8 | 来自 U/VU 的环境调用 | 是 | - |
| 9 | 来自 HS 的环境调用 | 只读 | 0 |
| 10 | 来自 VS 的环境调用 | 是 | - |
| 11 | 来自 M 的环境调用 | 只读 | 0 |
| 12 | 指令页故障 | 只读 | 0 |
| 13 | 加载页故障 | 只读 | 0 |
| 14 | 保留 | 只读 | 0 |
| 15 | 存储/AMO 页故障 | 只读 | 0 |
| 16 | 软件检查 | 是 | - |
| 17 | 硬件错误 | 是 | - |
| 18 | 指令客户机页故障 | 是 | - |
| 19 | 加载客户机页故障 | 是 | - |
| 20 | 虚拟指令 | 是 | - |
| 21 | 存储/AMO 客户机页故障 | 是 | - |
| 22-23 | 保留 | 只读 | 0 |

## 虚拟指令异常

### 定义

当满足以下条件时，虚拟指令异常代替非法指令异常：
1. 指令在 HS 模式下是有效的（HS 限定）
2. 由于虚拟化（V=1）而阻止执行
3. 限制不是基本的特权违规

### 虚拟指令异常的原因

#### 计数器访问违规
- VS/VU 模式下访问计数器时 `hcounteren` 位为 0
- 适用于低位和高位计数器（XLEN=32）

#### 虚拟机监控器相关违规
- 在 VS/VU 模式下执行虚拟机指令（HLV、HLVX、HSV、HFENCE）
- 在 VS/VU 模式下直接访问虚拟机监控器 CSR 或 VS CSR
- 当对应的低位 CSR 受限访问高位 CSR

#### 监管器指令违规
- 在 VU 模式下执行 WFI（当 `mstatus.TW=0`）
- 在 VS 模式下执行 SRET（当 `hstatus.VTSR=1`）
- 在 VS 模式下执行 SFENCE.VMA/SINVAL.VMA（当 `hstatus.VTVM=1`）

#### 监管器 CSR 访问违规
- 没有适当权限访问监管器 CSR
- 包括常规和高端 CSR

### 特殊情况

当 FS/VS=0 时，浮点和向量指令总是引发非法指令异常，而不是虚拟指令异常。

## 客户机页故障

### 定义

客户机页故障在两级地址转换期间，当 G 级转换失败或权限被拒绝时发生。

### 故障类型

1. **指令客户机页故障**：指令获取期间
2. **加载客户机页故障**：加载访问期间
3. **存储/AMO 客户机页故障**：存储/AMO 访问期间

### 故障信息

当客户机页故障发生时：

| 寄存器 | 内容 |
|--------|---------|
| `mtval`/`stval`/`vstval` | 故障的客户机虚拟地址 |
| `mtval2`/`htval` | 故障的客户机物理地址（右移 2 位） |
| `mtinst`/`htinst` | 转换的指令或伪指令 |

### htval/mtval2 中的客户机物理地址

- **非零**：右移 2 位（适应大于 XLEN 的地址）
- **零**：故障发生在第一级（VS）转换中
- **隐式访问**：导致故障的 VS 页表项的地址

### 伪指令值

对于 VS 级转换隐式失败：

| 值 | 含义 |
|-----|------|
| 0x00002000 | VS 级转换的 32 位读取（RV32） |
| 0x00002020 | VS 级转换的 32 位写入（RV32） |
| 0x00003000 | VS 级转换的 64 位读取（RV64） |
| 0x00003020 | VS 级转换的 64 位写入（RV64） |

## 陷阱入口

### 陷阱流程

1. **发生**：某种特权模式下的异常或中断
2. **委托检查**：检查委托寄存器
3. **模式转换**：转换到适当的处理程序模式
4. **上下文保存**：保存相关状态
5. **处理程序执行**：执行陷阱处理程序代码

### 按模式的陷阱入口

#### U/HS 模式下的陷阱（V=0）
- 除非 `medeleg`/`mideleg` 委托，否则进入 M 模式
- 如果委托，进入 HS 模式

#### VU/VS 模式下的陷阱（V=1）
- 除非 `medeleg`/`mideleg` 委托，否则进入 M 模式
- 如果委托到 HS 模式，检查 `hedeleg`/`hideleg`
- 如果进一步委托，进入 VS 模式

### 保存的上下文

#### M 模式陷阱入口
- V 设置为 0
- `mstatus`/`mstatush`：更新 MPV、MPP、MPIE、MIE
- 写入 `mepc`、`mcause`、`mtval`、`mtval2`、`mtinst`

#### HS 模式陷阱入口
- V 设置为 0
- `hstatus`：更新 SPV、SPVP、GVA
- `sstatus`：更新 SPP、SPIE、SIE
- 写入 `sepc`、`scause`、`stval`、`htval`、`htinst`

#### VS 模式陷阱入口
- V 保持为 1
- `vsstatus`：更新 SPP
- 写入 `vsepc`、`vscause`、`vstval`
- HS 级 CSR 不变

### HS 模式陷阱时的 hstatus 字段

| 先前模式 | SPV | SPP |
|----------|-----|-----|
| U 模式 | 0 | 0 |
| HS 模式 | 0 | 1 |
| VU 模式 | 1 | 0 |
| VS 模式 | 1 | 1 |

### VS 模式陷阱时的 vsstatus SPP

| 先前模式 | SPP |
|----------|-----|
| VU 模式 | 0 |
| VS 模式 | 1 |

## 陷阱返回

### MRET

1. **确定新模式**：基于 MPP 和 MPV
2. **更新 mstatus**：MPV←0, MPP←0, MIE←MPIE, MPIE←1
3. **设置特权**：根据先前模式
4. **设置 PC**：mepc

### SRET

#### V=0 时
- **确定新模式**：基于 SPV 和 SPP
- **更新 hstatus**：SPV←0
- **更新 sstatus**：SPP←0, SIE←SPIE, SPIE←1
- **设置特权和 PC**：根据模式

#### V=1 时
- **更新 vsstatus**：SPP←0, SIE←SPIE, SPIE←1
- **设置特权**：根据 SPP
- **设置 PC**：vsepc

## 异常优先级

### 同步异常优先级（从高到低）

1. **指令地址断点**
2. **指令地址转换故障**（页故障、客户机页故障、访问故障）
3. **指令访问故障**
4. **非法指令 / 虚拟指令**
5. **环境调用 / 断点**
6. **加载/存储/AMO 地址断点**
7. **地址不对齐**（可选）
8. **地址转换故障**（页故障、客户机页故障、访问故障）
9. **加载/存储/AMO 访问故障**
10. **地址不对齐**（如果不是更高优先级）

## 转换的指令

### 目的

陷阱指令寄存器（`mtinst`/`htinst`）可以包含陷阱指令的转换版本，以帮助模拟。

### 转换规则

#### 加载/存储指令
- 原始指令，其中 rs1 被地址偏移量替换
- 立即数字段设置为零
- 保留 funct3、rd/rs2 和操作码

#### 原子指令
- 原始指令，位 19:15 包含地址偏移量
- 所有其他字段保留

#### 压缩指令
1. 扩展到 32 位等效
2. 转换 32 位指令
3. 将位 1 设置为 0

### 值编码

- **位 0 = 1**：标准指令编码
- **位 0 = 0，位 1 = 0**：伪指令
- **位 0 = 1，位 1 = 1**：压缩指令

## 与其他扩展的交互

### Ssdbltrp（双重陷阱）
- 启用双重陷阱检测
- 使用 `vsstatus.SDT` 位
- 影响陷阱优先级

### Zicfilp（着陆点）
- 修改前向控制流的陷阱处理
- 使用 `vsstatus.SPELP`
- 着陆点预测

### Zicfiss（影子栈）
- 附加异常类型
- 修改的 CSR 行为
- 影子栈违规