# SBI 嵌套加速功能特性

本文档详细描述了 RISC-V SBI 嵌套加速扩展（NACL）提供的所有功能特性。

## 功能分类

### 1. 共享内存管理

#### 1.1 共享内存设置

**功能 ID**: `SBI_EXT_NACL_SET_SHMEM` (0x0)

**描述**: 建立 L0 和 L1 虚拟机监控器之间的共享内存区域。

**参数**:
- `shmem_lo`: 共享内存物理地址低 32 位
- `shmem_hi`: 共享内存物理地址高 32 位（RV64）
- `flags`: 控制标志

**返回值**:
- 成功: SBI_SUCCESS (0)
- 失败:
  - SBI_ERR_INVALID_PARAM: 参数无效
  - SBI_ERR_INVALID_ADDRESS: 地址无效
  - SBI_ERR_DENIED: 权限被拒绝

**标志位定义**:
```c
#define NACL_SHMEM_FLAG_ENABLE    (1 << 0)  // 启用共享内存
#define NACL_SHMEM_FLAG_CLEAR     (1 << 1)  // 清零内存
#define NACL_SHMEM_FLAG_RESERVE   (1 << 2)  // 预留内存
```

#### 1.2 内存访问特性

- **原子访问**: 支持原子读写操作
- **缓存一致性**: 保证缓存一致性
- **内存屏障**: 提供内存屏障指令
- **对齐访问**: 支持对齐和非对齐访问

### 2. CSR 加速访问

#### 2.1 CSR 批量操作

**功能 ID**: `SBI_EXT_NACL_CSR_OPS` (0x1)

**描述**: 批量访问多个 H 扩展 CSR。

**操作类型**:
```c
#define NACL_CSR_READ    0  // 读取 CSR
#define NACL_CSR_WRITE   1  // 写入 CSR
#define NACL_CSR_EXCHG   2  // 交换 CSR 值
```

**批量操作格式**:
```c
struct nacl_csr_op {
    uint16_t csr_num;     // CSR 编号
    uint16_t flags;       // 操作标志
    uint32_t reserved;    // 保留字段
    uint64_t value;       // CSR 值
};
```

#### 2.2 支持的 CSR

| CSR 类别 | 支持的 CSR | 说明 |
|---------|-----------|------|
| 虚拟状态 | vsstatus, vstvec, vsscratch | VS 级状态管理 |
| 异常处理 | vsepc, vscause, vstval | 异常信息 |
| 内存管理 | vsatp, hgatp | 地址转换 |
| 中断管理 | hie, hip, hgeie, hgeip | 中断控制 |
| 委托控制 | hedeleg, hideleg | 异常委托 |

#### 2.3 脏位图机制

- **位图大小**: 128 字节 (1024 位)
- **位映射**: 每位对应一个 CSR
- **自动设置**: 写入时自动设置对应位
- **查询功能**: 支持位图查询操作

### 3. HFENCE 加速

#### 3.1 批量 HFENCE 操作

**功能 ID**: `SBI_EXT_NACL_HFENCE` (0x2)

**描述**: 批量执行 HFENCE 操作。

**操作类型**:
```c
#define NACL_HFENCE_VVMA   0  // VS 级虚拟内存栅栏
#define NACL_HFENCE_GVMA   1  // G 级虚拟内存栅栏
#define NACL_HFENCE_ALL    2  // 全局栅栏
```

**HFENCE 描述符**:
```c
struct nacl_hfence_desc {
    uint64_t start;       // 起始地址
    uint64_t size;        // 大小
    uint64_t asid;        // ASID 标识
    uint64_t vmid;        // VMID 标识
    uint32_t type;        // 栅栏类型
    uint32_t flags;       // 控制标志
};
```

#### 3.2 HFENCE 优化

- **延迟执行**: 可延迟到合适的时机执行
- **批量合并**: 相邻地址范围的 HFENCE 可以合并
- **选择性失效**: 支持精确的地址范围失效
- **VMID 隔离**: 不同 VMID 的操作完全隔离

### 4. SRET 加速

#### 4.1 嵌套 SRET 模拟

**功能 ID**: `SBI_EXT_NACL_SRET` (0x3)

**描述**: 模拟嵌套环境下的 SRET 指令执行。

**上下文结构**:
```c
struct nacl_sret_context {
    uint64_t sepc;        // 异常返回地址
    uint64_t sstatus;     // 状态寄存器
    uint64_t hstatus;     // 虚拟机监控器状态
    uint64_t vsstatus;    // 虚拟状态寄存器
    uint32_t flags;       // 控制标志
    uint32_t reserved;    // 保留字段
};
```

#### 4.2 自动交换机制

- **CSR 自动交换**: 自动处理 CSR 的保存和恢复
- **状态切换**: 支持虚拟化模式的状态切换
- **中断处理**: 集成中断返回处理
- **异常恢复**: 完整的异常恢复流程

### 5. 嵌套虚拟化支持

#### 5.1 两级虚拟化

**功能描述**: 支持 L1 虚拟机监控器运行虚拟化客户机。

- **HS 模式**: L1 虚拟机监控器运行模式
- **VS 模式**: L2 客户机运行模式
- **VU 模式**: L2 客户机用户模式

#### 5.2 状态虚拟化

- **虚拟化模式**: 支持扩展页表 (EPT) 虚拟化
- **中断虚拟化**: 完整的中断注入和路由
- **内存虚拟化**: 两级地址转换硬件支持
- **I/O 虚拟化**: 设备访问的虚拟化支持

#### 5.3 性能优化

- **减少 VM Exit**: 优化陷阱处理流程
- **批量操作**: 支持批量虚拟化操作
- **硬件加速**: 利用硬件虚拟化特性
- **预测执行**: 预测性执行优化

### 6. 中断加速

#### 6.1 虚拟中断注入

**功能 ID**: `SBI_EXT_NACL_INJECT_IRQ` (0x4)

**描述**: 向 L1 虚拟机监控器注入虚拟中断。

**中断类型**:
```c
#define NACL_IRQ_SOFT     0  // 软件中断
#define NACL_IRQ_TIMER    1  // 定时器中断
#define NACL_IRQ_EXTERNAL 2  // 外部中断
#define NACL_IRQ_PMU      3  // 性能监控中断
```

#### 6.2 中断路由

- **VMID 路由**: 基于 VMID 的中断路由
- **优先级管理**: 支持中断优先级
- **中断合并**: 相同类型中断的合并
- **延迟注入**: 可延迟中断注入时机

### 7. 性能监控

#### 7.1 计数器访问

**功能 ID**: `SBI_EXT_NACL_PMU` (0x5)

**描述**: 访问虚拟化性能计数器。

**支持的计数器**:
- VM Exit 次数统计
- CSR 访问次数统计
- HFENCE 执行次数统计
- 内存访问延迟统计

#### 7.2 性能事件

```c
struct nacl_pmu_event {
    uint32_t event_id;    // 事件 ID
    uint32_t flags;       // 事件标志
    uint64_t count;       // 计数值
    uint64_t time;        // 时间戳
};
```

### 8. 调试支持

#### 8.1 调试接口

**功能 ID**: `SBI_EXT_NACL_DEBUG` (0x6)

**描述**: 提供嵌套虚拟化调试支持。

**调试功能**:
- 单步执行支持
- 断点设置
- 寄存器访问
- 内存访问跟踪

#### 8.2 调试信息

- **执行跟踪**: 指令执行历史记录
- **异常跟踪**: 异常发生和恢复记录
- **性能分析**: 详细的性能分析数据
- **状态快照**: 系统状态快照功能

### 9. 错误处理和诊断

#### 9.1 错误代码定义

```c
#define NACL_ERR_SUCCESS        0   // 成功
#define NACL_ERR_INVALID_PARAM  1   // 参数无效
#define NACL_ERR_INVALID_ADDR   2   // 地址无效
#define NACL_ERR_DENIED         3   // 权限被拒绝
#define NACL_ERR_NOT_SUPPORTED  4   // 功能不支持
#define NACL_ERR_BUSY           5   // 资源忙
#define NACL_ERR_TIMEOUT        6   // 操作超时
#define NACL_ERR_NO_MEM         7   // 内存不足
#define NACL_ERR_IO_ERROR       8   // I/O 错误
#define NACL_ERR_PROTOCOL       9   // 协议错误
```

#### 9.2 诊断功能

- **状态查询**: 查询当前系统状态
- **错误统计**: 错误发生统计
- **健康检查**: 系统健康状态检查
- **恢复机制**: 错误恢复机制

### 10. 安全特性

#### 10.1 内存保护

- **访问控制**: 基于权限的内存访问控制
- **隔离保证**: 不同 VM 之间的内存隔离
- **完整性保护**: 内存数据的完整性保护
- **机密性保护**: 敏感数据的机密性保护

#### 10.2 特权检查

- **权限验证**: 严格的权限验证机制
- **操作审计**: 所有操作的审计日志
- **入侵检测**: 恶意行为检测
- **安全启动**: 安全启动流程支持

## 功能检测

### 检测 API

**功能 ID**: `SBI_EXT_NACL_PROBE` (0xFF)

**描述**: 检测平台支持的 NACL 功能。

```c
struct nacl_feature {
    uint32_t feature_id;   // 功能 ID
    uint32_t version;      // 功能版本
    uint32_t flags;        // 功能标志
    uint32_t reserved;     // 保留字段
};
```

### 功能版本

| 功能 | 初始版本 | 当前版本 | 说明 |
|------|---------|---------|------|
| 共享内存 | 1.0 | 1.2 | 支持动态内存管理 |
| CSR 加速 | 1.0 | 1.1 | 支持批量操作优化 |
| HFENCE 加速 | 1.0 | 1.0 | 基础 HFENCE 支持 |
| SRET 加速 | 1.0 | 1.3 | 支持自动交换优化 |
| 嵌套虚拟化 | 1.0 | 1.2 | 支持 EPT 虚拟化 |
| 中断加速 | 1.0 | 1.1 | 支持中断路由优化 |
| 性能监控 | 1.0 | 1.0 | 基础 PMU 支持 |
| 调试支持 | 1.0 | 1.0 | 基础调试功能 |

## 性能特性

### 延迟优化

- **零拷贝**: 减少不必要的数据拷贝
- **批量处理**: 批量处理减少调用开销
- **缓存优化**: 优化缓存命中率
- **预测执行**: 预测性执行减少延迟

### 吞吐量优化

- **并行处理**: 支持并行操作处理
- **流水线**: 流水线化操作处理
- **资源池化**: 资源池化管理
- **负载均衡**: 智能负载均衡

### 资源优化

- **内存使用**: 优化内存使用效率
- **CPU 利用**: 提高 CPU 利用率
- **I/O 优化**: 优化 I/O 操作效率
- **能耗管理**: 智能能耗管理

## 兼容性

### 硬件兼容性

- **RISC-V 32位**: 完全支持 RV32I 基础架构
- **RISC-V 64位**: 完全支持 RV64I 基础架构
- **H 扩展**: 需要硬件或模拟 H 扩展支持
- **可选扩展**: 支持多种可选 RISC-V 扩展

### 软件兼容性

- **SBI 版本**: 兼容 SBI 2.0 及以上版本
- **操作系统**: 支持主流 RISC-V 操作系统
- **虚拟机监控器**: 兼容主流 RISC-V 虚拟机监控器
- **工具链**: 支持标准 RISC-V 工具链

### 向后兼容

- **版本兼容**: 向后兼容早期版本
- **功能降级**: 不支持功能的优雅降级
- **接口稳定**: 保证 API 接口稳定性
- **迁移支持**: 提供版本迁移支持

## 未来扩展

### 计划功能

- **GPU 虚拟化**: 支持 GPU 设备虚拟化
- **网络虚拟化**: 增强网络设备虚拟化
- **存储虚拟化**: 优化存储设备虚拟化
- **安全增强**: 增加更多安全特性

### 接口扩展

- **更多 API**: 扩展更多功能 API
- **异步支持**: 支持异步操作接口
- **事件驱动**: 支持事件驱动模型
- **插件机制**: 支持功能插件机制

### 性能优化

- **硬件加速**: 利用更多硬件特性
- **算法优化**: 优化核心算法
- **缓存策略**: 改进缓存策略
- **预测模型**: 增强预测模型