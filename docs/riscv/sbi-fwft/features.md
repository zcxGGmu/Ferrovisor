# RISC-V SBI 固件特性详细说明

本文档详细描述了 SBI 固件特性扩展（FWFT）中定义的所有标准特性。

## 特性总览

| 特性 ID | 名称 | 描述 | 作用域 | 值范围 | 复位值 |
|---------|------|------|--------|---------|--------|
| 0x00000000 | MISALIGNED_EXC_DELEG | 非对齐访问异常委托 | 本地 | 0, 1 | 实现定义 |
| 0x00000001 | LANDING_PAD | 监督模式着陆垫支持 | 本地 | 0, 1 | 0 |
| 0x00000002 | SHADOW_STACK | 监督模式影子栈支持 | 本地 | 0, 1 | 0 |
| 0x00000003 | DOUBLE_TRAP | 双重陷阱支持 | 本地 | 0, 1 | 0 |
| 0x00000004 | PTE_AD_HW_UPDATING | PTE A/D 位硬件更新 | 本地 | 0, 1 | 1 |
| 0x00000005 | POINTER_MASKING_PMLEN | 指针掩码长度 | 本地 | 0, N | 0 |

## 标准特性详细说明

### 1. MISALIGNED_EXC_DELEG (0x00000000)

#### 描述
控制非对齐访问异常是否委托给监督模式软件处理。当启用时，非对齐的加载/存储访问会触发监督模式的异常，而不是在 M 模式处理。

#### 技术背景
- **传统处理**：非对齐访问通常在 M 模式处理或被禁止
- **委托优势**：监督模式可以提供更灵活的处理策略
- **性能影响**：可能提高某些应用的处理效率

#### 配置值
- **0**：禁用委托（默认行为）
- **1**：启用委托给监督模式

#### 应用场景
- **性能优化**：对特定工作负载启用优化处理
- **兼容性**：模拟其他架构的行为
- **调试**：在监督模式捕获非对齐访问

#### 硬件要求
- RISC-V 基础 ISA
- 非对齐访问支持（可选）
- 异常委托机制

#### 注意事项
- 需要监督模式软件正确处理异常
- 可能影响系统性能
- 某些平台可能不支持

### 2. LANDING_PAD (0x00000001)

#### 描述
控制监督模式的着陆垫（Landing Pad）支持。着陆垫是一种硬件机制，用于特权级别切换时的状态保存和恢复。

#### 技术背景
- **Zicfilp 扩展**：着陆垫预测的 RISC-V 扩展
- **安全机制**：防止控制流劫持攻击
- **性能优化**：减少上下文切换开销

#### 配置值
- **0**：禁用着陆垫（复位值）
- **1**：启用着陆垫支持

#### 应用场景
- **安全增强**：防止返回导向编程（ROP）攻击
- **系统调用优化**：快速特权级别切换
- **虚拟化支持**：优化虚拟机退出/进入

#### 硬件要求
- Zicfilp 扩展支持
- 着陆垫相关硬件机制
- 状态保存/恢复支持

#### 实现要求
- 需要硬件支持着陆垫指令
- 正确的状态管理
- 异常路径处理

### 3. SHADOW_STACK (0x00000002)

#### 描述
控制监督模式的影子栈（Shadow Stack）支持。影子栈是一种防御机制，用于防止返回地址篡改。

#### 技术背景
- **Zicfiss 扩展**：影子栈的 RISC-V 扩展
- **控制流完整性**：保证调用返回的正确性
- **安全特性**：防御内存安全漏洞

#### 配置值
- **0**：禁用影子栈（复位值）
- **1**：启用影子栈支持

#### 应用场景
- **安全应用**：高安全要求的系统
- **防护机制**：防止缓冲区溢出攻击
- **合规要求**：满足安全标准

#### 硬件要求
- Zicfiss 扩展支持
- 影子栈内存管理
- 地址空间隔离

#### 性能影响
- **内存开销**：额外的栈空间
- **执行开销**：额外的地址检查
- **缓存影响**：影子栈访问模式

#### 调试支持
- 影子栈状态查询
- 违规检测报告
- 调试信息保留

### 4. DOUBLE_TRAP (0x00000003)

#### 描述
控制双重陷阱（Double Trap）支持机制。双重陷阱是指在处理一个异常时又发生另一个异常的情况。

#### 技术背景
- **Ssdbltrp 扩展**：双重陷阱检测的 RISC-V 扩展
- **系统稳定性**：防止系统陷入无法恢复状态
- **错误处理**：提供更健壮的异常处理

#### 配置值
- **0**：禁用双重陷阱（复位值）
- **1**：启用双重陷阱支持

#### 应用场景
- **系统可靠性**：关键系统应用
- **错误恢复**：提供更好的错误处理
- **调试支持**：捕获深层异常

#### 硬件要求
- Ssdbltrp 扩展支持
- 嵌套异常处理机制
- 状态保存空间

#### 错误处理
- 双重陷阱检测
- 系统状态保存
- 恢复策略

#### 系统影响
- **性能开销**：额外的状态检查
- **内存使用**：额外的状态保存
- **延迟增加**：异常处理时间

### 5. PTE_AD_HW_UPDATING (0x00000004)

#### 描述
控制页表项（Page Table Entry）的访问（Accessed）和脏（Dirty）位的硬件自动更新机制。

#### 技术背景
- **内存管理**：页表维护的核心功能
- **软件开销**：传统软件更新的性能开销
- **硬件优化**：减少软件干预的需求

#### 配置值
- **0**：禁用硬件更新
- **1**：启用硬件更新（复位值）

#### 应用场景
- **性能优化**：减少软件维护开销
- **内存管理**：高效的页面管理
- **虚拟化**：虚拟机内存管理优化

#### 硬件要求
- PTE A/D 位支持
- 硬件更新机制
- 内存管理单元支持

#### 性能影响
- **正面影响**：减少软件开销
- **内存带宽**：可能增加内存访问
- **缓存使用**：影响缓存行为

#### 实现考虑
- 页面权限检查
- 写时复制处理
- 共享内存处理

### 6. POINTER_MASKING_PMLEN (0x00000005)

#### 描述
控制监督模式的指针掩码长度（Pointer Masking Length）。指针掩码是一种内存安全机制，用于检测指针错误使用。

#### 技术背景
- **内存安全**：防止指针越界访问
- **漏洞防护**：缓解内存安全漏洞
- **调试支持**：帮助检测指针错误

#### 配置值
- **0**：禁用指针掩码（复位值）
- **N**：启用指针掩码，长度为 N

其中 N 的取值取决于硬件支持：
- N 必须是 2 的幂
- 最大 N 值由硬件决定
- 典型值为 8、16、32 等

#### 应用场景
- **安全软件**：高安全要求的应用
- **内存安全**：防止内存错误
- **调试工具**：指针错误检测

#### 硬件要求
- 指针掩码硬件支持
- 地址转换机制
- 权限检查系统

#### 实现细节
- 掩码计算
- 地址验证
- 异常处理

## 平台特定特性

### 定义范围

平台特定特性的 ID 范围：
- **起始**：0x40000000
- **结束**：0x7FFFFFFF
- **总数**：1073741824 个可能值

### 典型平台特性

虽然具体特性由平台定义，但常见的平台特性可能包括：

#### 1. 缓存管理特性
- 缓存策略配置
- 预取控制
- 缓存分区

#### 2. 电源管理特性
- 动态电压频率调整（DVFS）
- 睡眠状态控制
- 功耗优化

#### 3. 安全特性
- 可信执行环境（TEE）
- 安全启动配置
- 加密加速器控制

#### 4. 调试特性
- 调试接口配置
- 跟踪控制
- 性能计数器

### 平台特性命名规范

建议的平台特性命名：
- 使用描述性名称
- 包含厂商标识
- 版本化特性定义
- 完整的文档说明

## 特性交互

### 依赖关系

某些特性之间存在依赖关系：

#### 1. 安全特性链
- SHADOW_STACK 可能依赖 LANDING_PAD
- DOUBLE_TRAP 可能影响异常处理链

#### 2. 内存管理链
- POINTER_MASKING 可能影响内存访问
- PTE_AD_UPDATING 影响页面管理

#### 3. 性能特性
- 多个特性可能相互影响性能

### 冲突处理

当特性配置存在冲突时：
- SBI 实现应拒绝冲突的配置
- 返回适当的错误码
- 提供冲突诊断信息

## 错误处理

### 标准错误码

特性操作的错误码：
- `SBI_SUCCESS`：操作成功
- `SBI_ERR_NOT_SUPPORTED`：不支持特性
- `SBI_ERR_INVALID_PARAM`：参数无效
- `SBI_ERR_DENIED`：请求被拒绝
- `SBI_ERR_DENIED_LOCKED`：特性已锁定
- `SBI_ERR_FAILED`：其他错误

### 错误场景

#### 1. 不支持的特性
- 硬件不支持
- 固件未实现
- 版本不兼容

#### 2. 无效的值
- 超出值范围
- 不合法的配置
- 依赖特性未启用

#### 3. 权限问题
- 虚拟化环境限制
- 安全策略禁止
- 特性已锁定

## 最佳实践

### 特性查询

```c
// 标准查询模式
struct sbiret ret = sbi_fwft_get(feature_id);
if (ret.error == SBI_SUCCESS) {
    // 特性支持，使用 ret.value
} else if (ret.error == SBI_ERR_NOT_SUPPORTED) {
    // 特性不支持，使用替代方案
}
```

### 特性设置

```c
// 安全设置模式
ret = sbi_fwft_set(feature_id, value, 0);
if (ret.error == SBI_SUCCESS) {
    // 设置成功
} else if (ret.error == SBI_ERR_DENIED_LOCKED) {
    // 特性已锁定，需要系统重启
}
```

### 错误处理

```c
// 完整的错误处理
switch (ret.error) {
    case SBI_SUCCESS:
        // 成功处理
        break;
    case SBI_ERR_NOT_SUPPORTED:
        // 降级处理
        break;
    case SBI_ERR_INVALID_PARAM:
        // 参数错误
        break;
    case SBI_ERR_DENIED:
        // 权限错误
        break;
    default:
        // 未知错误
        break;
}
```

## 调试支持

### 状态查询

- 查询当前特性配置
- 验证特性生效状态
- 检查特性依赖关系

### 诊断信息

- 特性失败原因
- 硬件能力报告
- 系统兼容性信息

### 调试工具

- 特性配置检查器
- 性能影响分析
- 安全策略验证